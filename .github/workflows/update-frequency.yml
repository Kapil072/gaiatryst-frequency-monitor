name: Hourly Frequency Update

on:
  schedule:
    - cron: '0 * * * *'  # Runs at minute 0 of every hour
  workflow_dispatch:      # Allows manual trigger

permissions:
  contents: write

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install selenium webdriver-manager

      - name: Fetch and save data
        run: |
          python << 'EOF'
          import json
          import time
          import datetime
          import sys
          from selenium import webdriver
          from selenium.webdriver.chrome.service import Service
          from selenium.webdriver.chrome.options import Options
          from webdriver_manager.chrome import ChromeDriverManager

          # --- CONFIG ---
          TARGET_URL = "https://nocc.heartmath.org/power_levels/public/charts/power_levels.html"
          ALL_GCI_STATIONS = ["GCI001", "GCI002", "GCI003", "GCI004", "GCI005", "GCI006"]
          OUTPUT_FILE = "data.json"

          def get_selenium_data():
              print("Launch headless browser...")
              
              chrome_options = Options()
              chrome_options.add_argument("--headless")
              chrome_options.add_argument("--no-sandbox")
              chrome_options.add_argument("--disable-dev-shm-usage")
              
              # Auto-install correct driver
              service = Service(ChromeDriverManager().install())
              driver = webdriver.Chrome(service=service, options=chrome_options)
              
              try:
                  driver.get(TARGET_URL)
                  # Critical: Wait for Highcharts animation/loading
                  time.sleep(15) 
                  
                  # Execute JS to pull data directly from Highcharts object
                  script = """
                  if (typeof Highcharts !== 'undefined' && Highcharts.charts.length > 0) {
                      return Highcharts.charts[0].series.map(s => ({
                          name: s.name, 
                          data: s.options.data
                      }));
                  } else {
                      return null;
                  }
                  """
                  raw_data = driver.execute_script(script)
                  return raw_data
              except Exception as e:
                  print(f"Browser Error: {e}")
                  return None
              finally:
                  driver.quit()

          def process_data():
              raw_data = get_selenium_data()
              
              # Default Structure (Offline State)
              output_data = {
                  "timestamp": datetime.datetime.now(datetime.timezone.utc).strftime('%Y-%m-%d %H:%M:%S UTC'),
                  "last_update": datetime.datetime.now(datetime.timezone.utc).strftime('%Y-%m-%d %H:%M:%S UTC'),
                  "global_avg": 0.0,
                  "stations": {k: 0.0 for k in ALL_GCI_STATIONS},
                  "active_stations": 0,
                  "source": "HeartMath GCI (Selenium)",
                  "scrape_status": "failed",
                  "is_live": False
              }

              if not raw_data:
                  print("No data returned from Selenium.")
                  # We write the failed state so the frontend knows it's outdated
                  with open(OUTPUT_FILE, 'w') as f:
                      json.dump(output_data, f, indent=2)
                  return

              site_values = []
              stations_found = {}

              for series in raw_data:
                  name = series.get('name', '').strip()
                  # Filter only known GCI stations
                  if name not in ALL_GCI_STATIONS:
                      continue

                  points = series.get('data', [])
                  if points:
                      # Get the very last point (latest value)
                      # Highcharts data format is usually [timestamp, value]
                      last_point = points[-1]
                      val = last_point[1]
                      
                      # Only count positive values as "Active"
                      if val > 0:
                          stations_found[name] = val
                          site_values.append(val)
                      else:
                          stations_found[name] = 0

              # Update Output Data if we found stations
              if stations_found:
                  active_count = len(site_values)
                  avg = sum(site_values) / active_count if active_count > 0 else 0
                  
                  output_data["global_avg"] = round(avg, 2)
                  output_data["stations"] = stations_found
                  output_data["active_stations"] = active_count
                  output_data["scrape_status"] = "success"
                  output_data["is_live"] = True
                  print(f"Success! Global Avg: {avg:.2f}")
              
              # Save to JSON
              with open(OUTPUT_FILE, 'w') as f:
                  json.dump(output_data, f, indent=2)
              print(f"Saved to {OUTPUT_FILE}")

          if __name__ == "__main__":
              process_data()
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data.json
          # Only commit if data.json actually changed
          git diff --quiet && git diff --staged --quiet || git commit -m "Update frequency data - $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push
